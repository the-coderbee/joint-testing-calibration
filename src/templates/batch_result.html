{% extends "base.html" %}

{% block title %}Batch Prediction Results{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    .result-card {
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    .summary-header {
        background-color: #17a2b8;
        color: white;
        padding: 15px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .summary-value {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
    }
    .fail {
        color: #dc3545;
    }
    .success {
        color: #28a745;
    }
    .filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="my-4">Batch Prediction Results</h1>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card result-card h-100">
            <div class="summary-header">
                <h5 class="mb-0">Processed Rows</h5>
            </div>
            <div class="card-body text-center">
                <div class="summary-value">{{ result_df.shape[0] }}</div>
                <p class="text-muted">Total rows processed</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card result-card h-100">
            <div class="summary-header">
                <h5 class="mb-0">Calibration Predictions</h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-md-4">
                        <div class="summary-value">{{ "%.4f"|format(result_df.prediction.min()) }}</div>
                        <p class="text-muted">Minimum</p>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-value">{{ "%.4f"|format(result_df.prediction.mean()) }}</div>
                        <p class="text-muted">Average</p>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-value">{{ "%.4f"|format(result_df.prediction.max()) }}</div>
                        <p class="text-muted">Maximum</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if plot_url %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Calibration Curve</h5>
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ plot_url }}" alt="Calibration Curve" class="img-fluid">
                <p class="text-muted mt-2">Calibration curve showing the distribution of predictions</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mb-4 d-flex justify-content-between align-items-center">
    <h2>Results Table</h2>
    <a href="{{ url_for('download_file', filename='prediction_results.csv') }}" class="btn btn-success">
        <i class="bi bi-download"></i> Download CSV
    </a>
</div>

<div class="filters mb-4">
    <div class="row">
        <div class="col-md-6 mb-3 mb-md-0">
            <input type="text" id="tableSearch" class="form-control" placeholder="Search results...">
        </div>
        <div class="col-md-6">
            <button class="btn btn-outline-secondary w-100" id="resetFilters">Reset Filters</button>
        </div>
    </div>
</div>

<div class="table-responsive mb-5">
    <table class="table table-striped table-hover" id="resultsTable">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                {% for col in result_df.columns %}
                <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for idx, row in result_df.iterrows() %}
            <tr>
                <td>{{ idx + 1 }}</td>
                {% for col in result_df.columns %}
                <td>
                    {% if col == 'prediction' %}
                        {{ "%.4f"|format(row[col]) }}
                    {% else %}
                        {{ row[col] }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-center mb-5">
    <a href="/" class="btn btn-primary">Back to Predictor</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Table search functionality
    const tableSearch = document.getElementById('tableSearch');
    const resetFilters = document.getElementById('resetFilters');
    const resultsTable = document.getElementById('resultsTable');
    const tableRows = resultsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    function applyFilters() {
        const searchText = tableSearch.value.toLowerCase();
        
        for (let row of tableRows) {
            let matchesSearch = false;
            
            // Search filter
            for (let cell of row.getElementsByTagName('td')) {
                if (cell.textContent.toLowerCase().includes(searchText)) {
                    matchesSearch = true;
                    break;
                }
            }
            
            // Show/hide row based on filters
            row.style.display = matchesSearch ? '' : 'none';
        }
    }
    
    if (tableSearch) {
        tableSearch.addEventListener('input', applyFilters);
    }
    
    if (resetFilters) {
        resetFilters.addEventListener('click', function() {
            if (tableSearch) tableSearch.value = '';
            applyFilters();
        });
    }
</script>
{% endblock %} 